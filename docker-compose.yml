version: '3.8'

services:
  moli-door:
    build: .
    image: bs10081/moli-door:dev  # Use dev tag to distinguish from stable version
    container_name: moli-door-system
    restart: unless-stopped
    
    # Privileged mode for GPIO and device access
    privileged: true
    
    # Device mappings
    devices:
      - /dev/gpiomem:/dev/gpiomem  # GPIO access
      - /dev/input:/dev/input      # RFID reader access
    
    # Port mapping (FastAPI port 8000)
    ports:
      - "8000:8000"
    
    # Volume for persistent database
    volumes:
      - ./data:/app/data
      - /dev:/dev  # Full device access
    
    # Environment variables (can be customized)
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=sqlite:///./data/moli_door.db
      - LOCK_PIN=16
      - LOCK_ACTIVE_LEVEL=1
      - LOCK_DURATION=3
      - REGISTER_TIMEOUT=90
    
    # Network mode: host for better device access
    network_mode: host
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
